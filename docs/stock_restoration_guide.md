# دليل إرجاع المخزون عند إلغاء الطلبات
## Stock Restoration Guide for Order Cancellation

## نظرة عامة
تم تطوير نظام متكامل لإرجاع المنتجات للمخزون تلقائياً عند إلغاء الطلبات من قبل العملاء أو المشرفين.

## الميزات الرئيسية

### 1. إرجاع المخزون التلقائي
- عند إلغاء أي طلب، يتم إرجاع جميع المنتجات للمخزون تلقائياً
- يعمل النظام مع جميع حالات الإلغاء (عميل أو مشرف)
- يتم التحقق من صحة البيانات قبل الإرجاع

### 2. التحقق من صحة العمليات
- التأكد من أن الطلب قابل للإلغاء (ليس مشحون أو مسلم)
- التحقق من وجود المنتجات في الطلب
- منع الإلغاء المتكرر للطلب الواحد

### 3. تسجيل العمليات
- تسجيل جميع عمليات الإلغاء في ملف السجل
- تتبع تفاصيل إرجاع المخزون لكل منتج
- إمكانية مراجعة العمليات للتدقيق

## كيفية عمل النظام

### من جانب العميل
1. العميل يدخل لصفحة "طلباتي" في الملف الشخصي
2. يضغط على زر "إلغاء" للطلبات في حالة "في الانتظار"
3. يتم إرسال طلب AJAX لإلغاء الطلب
4. النظام يتحقق من صحة الطلب ويرجع المخزون
5. يتم عرض رسالة تأكيد للعميل

### من جانب المشرف
1. المشرف يدخل لصفحة "إدارة الطلبات"
2. يختار "ملغي" من قائمة تحديث حالة الطلب
3. النظام يستخدم دالة الإلغاء المخصصة
4. يتم إرجاع المخزون وتحديث حالة الطلب
5. يتم عرض رسالة تأكيد بنجاح العملية

## الملفات المتأثرة

### 1. classes/Order.php
- `cancelOrder()`: الدالة الرئيسية لإلغاء الطلب
- `restoreStock()`: دالة إرجاع المخزون
- تحسينات في التحقق من صحة البيانات

### 2. admin/orders.php
- تحديث معالجة تغيير حالة الطلب
- استخدام دالة الإلغاء المخصصة عند اختيار "ملغي"

### 3. ajax/cancel_order.php
- معالجة طلبات الإلغاء من العملاء
- التحقق من الصلاحيات والبيانات

### 4. profile.php
- عرض أزرار الإلغاء للطلبات المناسبة
- JavaScript لمعالجة عمليات الإلغاء

## الملفات الجديدة

### 1. test_stock_restoration.php
- ملف اختبار لوظيفة إرجاع المخزون
- يمكن تشغيله للتأكد من عمل النظام

### 2. admin/stock-report.php
- تقرير شامل عن حالة المخزون
- عرض الطلبات الملغية والمنتجات منخفضة المخزون

### 3. database/optimize_stock_queries.sql
- فهارس لتحسين أداء استعلامات المخزون
- جداول إضافية لتتبع حركات المخزون (اختياري)

## طريقة الاختبار

### 1. اختبار يدوي
```bash
# افتح المتصفح واذهب إلى:
http://localhost/proj/test_stock_restoration.php
```

### 2. اختبار من لوحة التحكم
1. اذهب لإدارة الطلبات
2. اختر طلب في حالة "في الانتظار"
3. غير الحالة إلى "ملغي"
4. تحقق من زيادة المخزون في صفحة المنتجات

### 3. اختبار من جانب العميل
1. سجل دخول كعميل
2. اذهب للملف الشخصي > طلباتي
3. ألغي طلب في حالة "في الانتظار"
4. تحقق من إرجاع المخزون

## رسائل السجل

### رسائل النجاح
```
Order #123 cancelled successfully. Stock restored for 3 items.
Stock restored for product 45: +2 units
```

### رسائل الخطأ
```
Order cancellation error for order #123: [تفاصيل الخطأ]
Invalid order item data for stock restoration: [البيانات]
Failed to restore stock for product 45
```

## الحالات المدعومة

### ✅ يمكن إلغاؤها
- `pending` (في الانتظار)
- `confirmed` (مؤكد)

### ❌ لا يمكن إلغاؤها
- `shipped` (تم الشحن)
- `delivered` (تم التسليم)
- `cancelled` (ملغي مسبقاً)

## التحسينات المستقبلية

### 1. تتبع متقدم للمخزون
- إضافة جدول `stock_movements` لتتبع جميع حركات المخزون
- تقارير مفصلة عن تاريخ تغييرات المخزون

### 2. إشعارات تلقائية
- إشعار المشرف عند نفاد المخزون
- تنبيهات عند وصول المخزون لحد أدنى

### 3. تحليلات متقدمة
- إحصائيات عن أسباب إلغاء الطلبات
- تقارير عن تأثير الإلغاءات على المخزون

## الأمان والموثوقية

### 1. التحقق من الصلاحيات
- العملاء يمكنهم إلغاء طلباتهم فقط
- المشرفون يمكنهم إلغاء أي طلب

### 2. المعاملات (Transactions)
- جميع عمليات الإلغاء تتم داخل معاملة واحدة
- في حالة فشل أي جزء، يتم التراجع عن العملية كاملة

### 3. التحقق من صحة البيانات
- التأكد من وجود الطلب والمنتجات
- التحقق من صحة الكميات قبل الإرجاع

## الدعم والصيانة

### مراجعة السجلات
```bash
# في ملف error.log ابحث عن:
grep "Order.*cancelled" /path/to/error.log
grep "Stock restored" /path/to/error.log
```

### استعلامات مفيدة
```sql
-- عرض الطلبات الملغية اليوم
SELECT * FROM orders 
WHERE status = 'cancelled' 
AND DATE(updated_at) = CURDATE();

-- عرض المنتجات منخفضة المخزون
SELECT * FROM products 
WHERE stock_quantity <= 5 
AND status = 'active';
```

## الخلاصة
تم تطوير نظام شامل وموثوق لإرجاع المخزون عند إلغاء الطلبات، مع ضمانات الأمان والموثوقية، وإمكانيات المراقبة والتتبع.
